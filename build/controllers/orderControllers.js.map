{"version":3,"sources":["../../server/src/controllers/orderControllers.js"],"names":["OrderControllers","req","res","body","mealId","quantity","OrderItem","findOne","where","userId","orderItem","response","status","message","create","newOrderItem","data","json","Order","findAll","catererId","orders","include","Meal","orderItems","Error","meals","total","forEach","orderMeal","meal","push","price","order","orderId","params","action","id","name","update","destroy","caterers","Set","add","OrderController","reduceQuantity","createOrders","user","then","dbMeal","Menu","menu","menuMeals","JSON","parse","updatedMenuMeals","map","menuMeal","updatedMenuMeal","stringify","shift","length","caterer","catererTotal","catererMeals","filter","catererMeal","delivery_status"],"mappings":"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","sourcesContent":["//import Order from \"../models/orders\";\r\n//import OrderItem from \"../models/orderItem\";\r\n//import Meal from \"../models/meals\";\r\n//import Menu from \"../models/menu\";\r\n\r\nclass OrderControllers {\r\n  static async postOrder(req, res) {\r\n    try {\r\n      const { mealId, quantity } = req.body;\r\n      const orderItem = await OrderItem.findOne({\r\n        where: { mealId, userId: 4 }\r\n      });\r\n      const response = {};\r\n      if (orderItem) {\r\n        response.body = {\r\n          status: \"warning\",\r\n          message: \"Order Already exists\"\r\n        };\r\n      } else {\r\n        const newOrderItem = await OrderItem.create({\r\n          mealId,\r\n          quantity,\r\n          userId: 4\r\n        });\r\n        response.body = {\r\n          status: \"success\",\r\n          message: \"Added to Orders\",\r\n          data: newOrderItem\r\n        };\r\n      }\r\n      return res.status(200).json(response.body);\r\n    } catch (err) {\r\n      return res.status(500).json({\r\n        status: \"error\",\r\n        message: err.message\r\n      });\r\n    }\r\n  }\r\n\r\n  static async getOrder(req, res) {\r\n    try {\r\n      const orders = await Order.findAll({\r\n        where: { catererId: 2 }\r\n      });\r\n      return res.status(200).json({\r\n        status: \"success\",\r\n        message: \"Orders Retrieved\",\r\n        data: orders\r\n      });\r\n    } catch (err) {\r\n      return res.status(500).json({\r\n        status: \"error\",\r\n        message: err.message\r\n      });\r\n    }\r\n  }\r\n\r\n  static async getOrderItems(req, res) {\r\n    try {\r\n      const orderItems = await OrderItem.findAll({\r\n        where: { userId: 4 },\r\n        include: [Meal]\r\n      });\r\n      if (!orderItems) {\r\n        throw new Error(\"User Has No Order Items\");\r\n      }\r\n      const meals = [];\r\n      let total = 0;\r\n      orderItems.forEach(orderItem => {\r\n        const orderMeal = { ...orderItem };\r\n        orderMeal.meal.quantity = orderItem.quantity;\r\n        meals.push(orderMeal.meal);\r\n        total += orderItem.quantity * orderMeal.meal.price;\r\n      });\r\n      const order = { meals, total };\r\n      return res.status(200).json({\r\n        status: \"success\",\r\n        message: \"Orders Retrieved\",\r\n        data: order\r\n      });\r\n    } catch (err) {\r\n      return res.status(500).json({\r\n        status: \"error\",\r\n        message: err.message\r\n      });\r\n    }\r\n  }\r\n\r\n  static async updateOrderName(req, res) {\r\n    try {\r\n      const { orderId } = req.params;\r\n      const { action } = req.body;\r\n      const orderItem = await OrderItem.findOne({\r\n        where: { id: orderId, userId: 4 },\r\n        include: [Meal]\r\n      });\r\n      if (action === \"increase\") {\r\n        orderItem.quantity += 1;\r\n        if (orderItem.quantity > orderItem.meal.quantity) {\r\n          throw new Error(\r\n            `Only ${orderItem.meal.quantity} servings of ${\r\n              orderItem.meal.name\r\n            } is available`\r\n          );\r\n        }\r\n        await OrderItem.update(\r\n          { quantity: orderItem.quantity },\r\n          { where: { id: orderItem.id } }\r\n        );\r\n      } else if (action === \"decrease\") {\r\n        orderItem.quantity -= 1;\r\n        if (orderItem.quantity === 0) {\r\n          await OrderItem.destroy({ where: { id: orderItem.id } });\r\n        } else {\r\n          await OrderItem.update(\r\n            { quantity: orderItem.quantity },\r\n            { where: { id: orderItem.id } }\r\n          );\r\n        }\r\n      } else if (action === \"delete\") {\r\n        await OrderItem.destroy({ where: { id: orderItem.id } });\r\n      }\r\n      return res.status(200).json({\r\n        status: \"success\",\r\n        message: \"Order Updated\"\r\n      });\r\n    } catch (err) {\r\n      return res.status(500).json({\r\n        status: \"error\",\r\n        message: err.message\r\n      });\r\n    }\r\n  }\r\n\r\n  static async checkoutOrders(req, res) {\r\n    try {\r\n      const orderItems = await OrderItem.findAll({\r\n        where: { userId: 4 },\r\n        include: [Meal]\r\n      });\r\n      const meals = [];\r\n      const caterers = new Set();\r\n      orderItems.forEach(orderItem => {\r\n        const orderMeal = { ...orderItem };\r\n        orderMeal.meal.quantity = orderItem.quantity;\r\n        meals.push(orderMeal.meal);\r\n        caterers.add(orderMeal.meal.catererId);\r\n      });\r\n      await OrderController.reduceQuantity(meals);\r\n      await OrderItem.destroy({ where: { userId: 4 } });\r\n      await OrderController.createOrders(\r\n        caterers,\r\n        meals,\r\n        req.user.id\r\n      );\r\n      return res.status(201).json({\r\n        status: \"success\",\r\n        message: \"Order Made\"\r\n      });\r\n    } catch (err) {\r\n      return res.status(500).json({\r\n        status: \"error\",\r\n        message: err.message\r\n      });\r\n    }\r\n  }\r\n\r\n  static async reduceQuantity(meals) {\r\n    try {\r\n      const meal = meals[0];\r\n      Meal.findOne({ where: { id: meal.id } })\r\n        .then(dbMeal => {\r\n          return dbMeal.update(\r\n            { quantity: dbMeal.quantity - meal.quantity },\r\n            { where: { id: meal.id } }\r\n          );\r\n        })\r\n        .then(() => {\r\n          return Menu.findOne({ where: { catererId: meal.catererId } });\r\n        })\r\n        .then(menu => {\r\n          const menuMeals = JSON.parse(menu.meals);\r\n          const updatedMenuMeals = menuMeals.map(menuMeal => {\r\n            const updatedMenuMeal = { ...menuMeal };\r\n            if (menuMeal.id === meal.id) {\r\n              updatedMenuMeal.quantity -= meal.quantity;\r\n            }\r\n            return updatedMenuMeal;\r\n          });\r\n          return menu.update(\r\n            { meals: JSON.stringify(updatedMenuMeals) },\r\n            { where: { id: menu.id } }\r\n          );\r\n        })\r\n        .then(() => {\r\n          meals.shift();\r\n          if (meals.length !== 0) {\r\n            OrderController.reduceQuantity(meals);\r\n          } else {\r\n            return true;\r\n          }\r\n        });\r\n    } catch (err) {\r\n      throw new Error(err.message);\r\n    }\r\n  }\r\n\r\n  static async createOrders(caterers, meals,  userId) {\r\n    try {\r\n      caterers.forEach(async caterer => {\r\n        let catererTotal = 0;\r\n        const catererMeals = meals.filter(meal => meal.catererId === caterer);\r\n        catererMeals.forEach(catererMeal => {\r\n          catererTotal += catererMeal.quantity * catererMeal.price;\r\n        });\r\n        await Order.create({\r\n          order: JSON.stringify(catererMeals),\r\n          total: catererTotal,\r\n          catererId: caterer,\r\n          userId,\r\n          delivery_status: 0\r\n        });\r\n      });\r\n    } catch (err) {\r\n      throw new Error(err.message);\r\n    }\r\n  }\r\n}\r\n\r\nexport default OrderControllers;\r\n"],"file":"orderControllers.js"}